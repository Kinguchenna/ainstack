<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Audio Cleaner</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="container mt-5">

    <h2>Upload Audio for Cleaning</h2>
    <form id="downloadForm">
        <input type="file" id="audio_file" name="audio_file" accept="audio/*" required class="form-control mb-3">
        <button type="submit" class="btn btn-success">Upload & Clean</button>
        <div class="spinner-border text-primary spinner" style="display: none;" role="status"></div>
    </form>

    <div id="progressBar" class="progress mt-3" style="display: none;">
        <div id="progress" class="progress-bar" role="progressbar" style="width: 0%;">Uploading...</div>
    </div>

    <div id="error-message" class="alert alert-danger mt-3" style="display: none;"></div>

    <div id="result" class="mt-4" style="display: none;"></div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.getElementById("downloadForm");
            const audioInput = document.getElementById("audio_file");
            const resultDiv = document.getElementById("result");
            const progressBar = document.getElementById("progressBar");
            const progress = document.getElementById("progress");
            const errorBox = document.getElementById("error-message");

            form.addEventListener("submit", function (e) {
                e.preventDefault();
                document.querySelector(".spinner").style.display = "inline-block";

                const file = audioInput.files[0];

                if (!file) {
                    errorBox.style.display = "block";
                    errorBox.innerText = "Please select an audio file.";
                    document.querySelector(".spinner").style.display = "none";
                    return;
                }

                if (file.size > 20 * 1024 * 1024) {
                    errorBox.style.display = "block";
                    errorBox.innerText = "File too large. Max allowed size is 20MB.";
                    document.querySelector(".spinner").style.display = "none";
                    return;
                }

                errorBox.style.display = "none";
                resultDiv.style.display = "none";
                progressBar.style.display = "block";
                progress.style.width = "30%";

                const formData = new FormData();
                formData.append("audio", file);

                fetch("/post-upload-audio/", {
                    method: "POST",
                    body: formData
                })
                    .then(res => res.json())
                    .then(data => {
                        progress.style.width = "100%";
                        document.querySelector(".spinner").style.display = "none";

                        if (data.success && data.url) {
                            resultDiv.style.display = "block";
                            resultDiv.innerHTML = `
                                <p><strong>Cleaned Audio:</strong></p>
                                <audio controls src="${data.url}" style="width: 100%;"></audio>
                                <br/>
                                <a class="btn btn-primary mt-2" download href="${data.url}">Download Cleaned File</a>
                            `;
                        } else {
                            errorBox.style.display = "block";
                            errorBox.innerText = data.error || "Cleaning failed.";
                        }
                    })
                    .catch(error => {
                        console.error("Error:", error);
                        errorBox.style.display = "block";
                        errorBox.innerText = "An error occurred while uploading the file.";
                    })
                    .finally(() => {
                        progressBar.style.display = "none";
                        progress.style.width = "0%";
                        document.querySelector(".spinner").style.display = "none";
                    });
            });
        });
    </script>

</body>
</html>
